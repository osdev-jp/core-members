2017/06/12 by uchan

# EDK II で UEFI アプリケーションを作る

この記事は UEFI アプリケーションを EDK II 上で作り、QEMU で動かすまでを解説します。動作確認は Ubuntu 16.04 でやっていますが、Linux ならどれも同じ方法で動作すると思います。

<!--more-->

## UEFI アプリを作る 3 つの方法

UEFI アプリを作るには、使う SDK によって主に 3 つの方法があります。参考記事：[UEFIのSDK事情 - syuu1228's blog](http://syuu1228.hatenablog.com/entry/20130130/1359552753)

- SDK を使わない
- gnu-uefi
- EDK II

SDK を使わないで作る方法は [ツールキットを使わずに UEFI アプリケーションの Hello World! を作る - 品川高廣（東京大学）のブログ](http://d.hatena.ne.jp/shina_ecc/20140819/1408434995) が参考になります。Hello World アプリを作るだけなら、恐らくこの方法が最も簡単だと思います。新しく買った UEFI 搭載の組み込みボードの動作をサクッと確認したい、みたいな用途にはちょうどいいでしょう。もちろん、必要となるすべての構造体を自分で定義する必要があったり、頼れるライブラリもないので、発展性は著しく低いですが。

gnu-uefi は UEFI API を叩くアプリケーションを作るためのものです。使い方が結構シンプルなようで、これを用いたサンプルを多く見かけます。ただ、命名規則 や ABI が UEFI の公式とはちょっと違ったり、UEFI で規定されている API のうちよく使うものしか実装されてなかったりして、使いこなすうちに物足りなくなることもあると教えてもらいました。

[EDK II](http://www.tianocore.org/edk2/) は UEFI の開発に深くかかわっている Intel が元々作っていた SDK です。gnu-efi が「UEFI アプリケーション」専用なのに対し、EDK II は UEFI アプリはもちろん、周辺のライブラリや、UEFI ファームウェアそのものを開発するための SDK という役割も持っており、超高機能です。高機能ゆえに UEFI アプリを作るという目的のためには複雑すぎてとっつきにくい印象があります。が、フル装備の SDK ですから、慣れておけば後々困ることもないと思います。ということで、この記事では EDK II への入門を目指します。

## EDK II の入手とセットアップ

EDK II SDK は GitHub から入手します。参照：[EDK II 公式サイト](http://www.tianocore.org/edk2/)

    $ git clone https://github.com/tianocore/edk2.git

入手できたら edk2 ディレクトリに移動し、edksetup.sh を読み込みます。

    $ cd edk2
    $ source edksetup.sh

`source edksetup.sh BaseTools` を実行するように書いてある解説ブログなどがあるのですが、現在のバージョンの EDK II では `BaseTools` 付けないのが正しいです。（付けたとしても単に無視されます。）

edksetup.sh が読み込まれると幾つかの環境変数が設定された旨が表示されます。以降のビルド作業などは、edksetup.sh を読み込んだシェル上で行ってください。

## EDK II のファイル構造

ここで EDK II のファイル構造を眺めておきましょう。この知識はアプリを作るときに役立つはずです。（なお、以下で登場する `$WORKSPACE` は git clone した edk2 ディレクトリへのパスを指します。）

    $WORKSPACE/
      Conf/
        target.txt      ビルド設定
        tools_def.txt   ツールチェーンの設定
      Build/            ビルド成果物が出力されるディレクトリ
      MdePkg/           EDK の中心的ライブラリのパッケージディレクトリ
      ...Pkg/           その他のパッケージディレクトリ
      edksetup.sh       環境変数設定用スクリプト

EDK II は大きく「パッケージ」としてディレクトリが分かれています。多くのパッケージは別のパッケージの機能を用いて実装されており、パッケージ間で依存関係を持っています。ただし MdePkg だけは他のパッケージに依存しておらず、その他のパッケージから利用されるライブラリとして構成されています。

次に、AppPkg の構造を見てみます。
